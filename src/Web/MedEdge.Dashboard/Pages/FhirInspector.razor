@page "/fhir-inspector"
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>FHIR Inspector - MedEdge</PageTitle>

<MudContainer MaxWidth="MaxWidth.Lg">
    <MudText Typo="Typo.h4" Class="mb-4">FHIR Resource Inspector</MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
                    <MudSelect @bind-Value="selectedResourceType" Label="Resource Type" Variant="Variant.Outlined" Style="min-width: 200px;">
                        <MudSelectItem Value="@ResourceType.Patient">Patient</MudSelectItem>
                        <MudSelectItem Value="@ResourceType.Device">Device</MudSelectItem>
                        <MudSelectItem Value="@ResourceType.Observation">Observation</MudSelectItem>
                    </MudSelect>

                    @if (selectedResourceType == ResourceType.Observation)
                    {
                        <MudTextField @bind-Value="filterPatientId" Label="Filter by Patient ID" Variant="Variant.Outlined" Style="min-width: 200px;" />
                        <MudTextField @bind-Value="filterDeviceId" Label="Filter by Device ID" Variant="Variant.Outlined" Style="min-width: 200px;" />
                    }

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@LoadResources">
                        Search
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@ExportCurrentResources">
                        Export as JSON
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        @if (isLoading)
        {
            <MudItem xs="12">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
            </MudItem>
        }
        else if (resources == null || resources.Count == 0)
        {
            <MudItem xs="12">
                <MudAlert Severity="Severity.Info">No resources found. Click Search to load data.</MudAlert>
            </MudItem>
        }
        else
        {
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle1">Found @resources.Count @selectedResourceType resources</MudText>
            </MudItem>

            <MudItem xs="12">
                <MudDataGrid Items="@resources" Striped="true" Hover="true" Breakpoint="Breakpoint.Sm">
                    <Columns>
                        <PropertyColumn Property="x => x.Id" Title="ID" />
                        @if (selectedResourceType == ResourceType.Patient)
                        {
                            <PropertyColumn Property="x => x.Name" Title="Name" />
                            <PropertyColumn Property="x => x.Gender" Title="Gender" />
                        }
                        @if (selectedResourceType == ResourceType.Device)
                        {
                            <PropertyColumn Property="x => x.Manufacturer" Title="Manufacturer" />
                            <PropertyColumn Property="x => x.Model" Title="Model" />
                        }
                        @if (selectedResourceType == ResourceType.Observation)
                        {
                            <PropertyColumn Property="x => x.Code" Title="LOINC Code" />
                            <PropertyColumn Property="x => x.Value" Title="Value" />
                        }
                        <TemplateColumn Title="Details" Sortable="false" Filterable="false">
                            <CellTemplate>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small" OnClick="@(() => ViewResourceDetails(context.Item))">
                                    View
                                </MudButton>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            </MudItem>
        }

        @if (selectedResource != null)
        {
            <MudItem xs="12">
                <MudExpansionPanel Text="@($"Resource Details: {selectedResource.Id}")" IsInitiallyExpanded="false">
                    <MudPaper Elevation="1" Class="pa-4" Style="background-color: #f5f5f5; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-word; max-height: 500px; overflow-y: auto;">
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: 'Courier New', monospace;">
                            @resourceJson
                        </MudText>
                    </MudPaper>
                </MudExpansionPanel>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private enum ResourceType
    {
        Patient,
        Device,
        Observation
    }

    private ResourceType selectedResourceType = ResourceType.Patient;
    private string filterPatientId = string.Empty;
    private string filterDeviceId = string.Empty;
    private List<ResourceSummary> resources = new();
    private ResourceSummary? selectedResource;
    private string resourceJson = string.Empty;
    private bool isLoading = false;

    private class ResourceSummary
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Gender { get; set; } = string.Empty;
        public string Manufacturer { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public string Code { get; set; } = string.Empty;
        public string Value { get; set; } = string.Empty;
        public JsonElement FullResource { get; set; }
    }

    private async Task LoadResources()
    {
        isLoading = true;
        try
        {
            resources.Clear();
            selectedResource = null;
            resourceJson = string.Empty;

            string url = selectedResourceType switch
            {
                ResourceType.Patient => "http://localhost:5001/fhir/Patient",
                ResourceType.Device => "http://localhost:5001/fhir/Device",
                ResourceType.Observation =>
                    $"http://localhost:5001/fhir/Observation" +
                    $"{(!string.IsNullOrEmpty(filterPatientId) ? $"?patient={filterPatientId}" : "")}" +
                    $"{(!string.IsNullOrEmpty(filterDeviceId) ? (string.IsNullOrEmpty(filterPatientId) ? "?" : "&") + $"device={filterDeviceId}" : "")}",
                _ => ""
            };

            if (string.IsNullOrEmpty(url))
            {
                Snackbar.Add("Invalid resource type", Severity.Error);
                return;
            }

            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var doc = JsonDocument.Parse(content);
                var root = doc.RootElement;

                // Parse FHIR Bundle
                if (root.TryGetProperty("entry", out var entries))
                {
                    var options = new JsonSerializerOptions { WriteIndented = true };

                    foreach (var entry in entries.EnumerateArray())
                    {
                        if (entry.TryGetProperty("resource", out var resource))
                        {
                            var summary = new ResourceSummary
                            {
                                FullResource = resource
                            };

                            if (resource.TryGetProperty("id", out var id))
                                summary.Id = id.GetString() ?? string.Empty;

                            // Extract type-specific fields
                            if (selectedResourceType == ResourceType.Patient)
                            {
                                if (resource.TryGetProperty("name", out var names))
                                {
                                    var firstName = names[0];
                                    var given = firstName.TryGetProperty("given", out var givenNames) ? givenNames[0].GetString() : "";
                                    var family = firstName.TryGetProperty("family", out var familyName) ? familyName.GetString() : "";
                                    summary.Name = $"{given} {family}";
                                }
                                if (resource.TryGetProperty("gender", out var gender))
                                    summary.Gender = gender.GetString() ?? string.Empty;
                            }

                            if (selectedResourceType == ResourceType.Device)
                            {
                                if (resource.TryGetProperty("manufacturer", out var mfg))
                                    summary.Manufacturer = mfg.GetString() ?? string.Empty;
                                if (resource.TryGetProperty("modelNumber", out var model))
                                    summary.Model = model.GetString() ?? string.Empty;
                            }

                            if (selectedResourceType == ResourceType.Observation)
                            {
                                if (resource.TryGetProperty("code", out var code))
                                {
                                    if (code.TryGetProperty("coding", out var codings))
                                    {
                                        var coding = codings[0];
                                        if (coding.TryGetProperty("code", out var codeValue))
                                            summary.Code = codeValue.GetString() ?? string.Empty;
                                    }
                                }
                                if (resource.TryGetProperty("value", out var value))
                                {
                                    if (value.TryGetProperty("value", out var val))
                                        summary.Value = val.GetString() ?? string.Empty;
                                }
                            }

                            resources.Add(summary);
                        }
                    }
                }

                Snackbar.Add($"Loaded {resources.Count} resources", Severity.Success);
            }
            else
            {
                Snackbar.Add($"API error: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ViewResourceDetails(ResourceSummary resource)
    {
        selectedResource = resource;
        var options = new JsonSerializerOptions { WriteIndented = true };
        resourceJson = JsonSerializer.Serialize(resource.FullResource, options);
    }

    private async Task ExportCurrentResources()
    {
        if (resources.Count == 0)
        {
            Snackbar.Add("No resources to export", Severity.Warning);
            return;
        }

        try
        {
            var options = new JsonSerializerOptions { WriteIndented = true };
            var exportData = new
            {
                resourceType = "Bundle",
                type = "collection",
                timestamp = DateTime.UtcNow.ToString("o"),
                total = resources.Count,
                entry = resources.Select(r => new { resource = r.FullResource }).ToList()
            };

            var json = JsonSerializer.Serialize(exportData, options);

            // In a real app, this would trigger a file download
            Snackbar.Add($"Export ready ({json.Length} bytes)", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export error: {ex.Message}", Severity.Error);
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        await Task.CompletedTask;
    }
}
