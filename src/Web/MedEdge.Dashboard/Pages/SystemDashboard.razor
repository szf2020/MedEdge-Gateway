@page "/system-dashboard"
@page "/"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.SignalR.Client
@using MedEdge.Dashboard.Services
@inject HttpClient Http
@inject IAppConfigurationService ConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>System Dashboard - MedEdge</PageTitle>

<style>
    .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 12px 20px 20px 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
        min-height: 100vh;
    }

    .header-section {
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, #007a2e 100%);
        border-radius: 12px;
        padding: 16px 24px;
        color: white;
        box-shadow: 0 8px 24px rgba(0, 150, 57, 0.25);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 64px;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .header-text-container {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .header-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        color: white;
    }

    .header-subtitle {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
        margin: 0;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .version-badge {
        color: rgba(255,255,255,0.7);
        font-size: 11px;
        font-weight: 700;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 4px 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.15);
    }

    .realtime-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        font-size: 11px;
        font-weight: 600;
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: blink 1s infinite;
    }

    @@keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .mud-main-content {
        padding-top: 8px !important;
    }

    .header-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .stat-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--mud-palette-primary), var(--mud-palette-primary-darken));
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        background: linear-gradient(135deg, var(--mud-palette-primary), var(--mud-palette-primary-darken));
        color: white;
    }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
        font-weight: 600;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--mud-palette-primary);
        line-height: 1;
    }

    .stat-subtitle {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    /* Workflow Section */
    .workflow-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .workflow-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .workflow-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .workflow-canvas {
        position: relative;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        padding: 32px;
        min-height: 500px;
        overflow-x: auto;
    }

    .layer-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
    }

    .workflow-layer {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .layer-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .layer-indicator {
        width: 4px;
        height: 24px;
        border-radius: 2px;
    }

    .layer-name {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        color: var(--mud-palette-text-secondary);
    }

    .layer-content {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
        position: relative;
    }

    /* Flow arrows between layers */
    .flow-arrow-down {
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        pointer-events: none;
        z-index: 5;
    }

    .flow-arrow-line {
        width: 2px;
        height: 20px;
        background: linear-gradient(to bottom, var(--mud-palette-primary), #22c55e);
    }

    .flow-arrow-head {
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid #22c55e;
    }

    .connection-row {
        position: absolute;
        bottom: -28px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 16px;
        pointer-events: none;
        z-index: 5;
    }

    .arrow-wrapper {
        min-width: 160px;
        display: flex;
        justify-content: center;
    }

    .workflow-node {
        position: relative;
        background: white;
        border: 2px solid var(--mud-palette-divider);
        border-radius: 12px;
        padding: 16px 20px;
        min-width: 160px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .workflow-node:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 24px rgba(0, 150, 57, 0.2);
        border-color: var(--mud-palette-primary);
    }

    .workflow-node.active {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-color: var(--mud-palette-primary);
    }

    .workflow-node.status-healthy {
        border-color: #22c55e;
    }

    .workflow-node.status-warning {
        border-color: #f59e0b;
    }

    .workflow-node.status-error {
        border-color: #ef4444;
    }

    .node-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--mud-palette-primary);
        color: white;
        font-size: 20px;
    }

    .node-icon.status-healthy {
        background: #22c55e;
    }

    .node-icon.status-warning {
        background: #f59e0b;
    }

    .node-icon.status-error {
        background: #ef4444;
    }

    .node-name {
        font-size: 13px;
        font-weight: 600;
        text-align: center;
    }

    .node-status {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.healthy {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        animation: pulse-green 2s infinite;
    }

    .status-dot.warning {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        animation: pulse-orange 2s infinite;
    }

    .status-dot.error {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        animation: pulse-red 2s infinite;
    }

    @@keyframes pulse-green {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    @@keyframes pulse-orange {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    @@keyframes pulse-red {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    /* Detail Panels */
    .detail-panel {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }

    .detail-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        border-left: 4px solid var(--mud-palette-primary);
    }

    .detail-card.warning {
        border-left-color: #f59e0b;
    }

    .detail-card.error {
        border-left-color: #ef4444;
    }

    .detail-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .detail-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--mud-palette-text-primary);
    }

    .detail-subtitle {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        margin-top: 4px;
    }

    /* Service List */
    .service-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .service-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.2s ease;
    }

    .service-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .service-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .service-status.online {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .service-status.offline {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
    }

    .service-status.warning {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }

    .service-info {
        flex: 1;
    }

    .service-name {
        font-weight: 600;
        font-size: 14px;
    }

    .service-description {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .service-url {
        font-size: 11px;
        color: var(--mud-palette-primary);
        font-family: monospace;
    }

    /* Device List */
    .device-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .device-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .device-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .device-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .device-status.online {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .device-status.offline {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
    }

    .device-info {
        flex: 1;
    }

    .device-name {
        font-weight: 600;
        font-size: 14px;
    }

    .device-type {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .device-risk {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .device-risk.low {
        background: #dcfce7;
        color: #166534;
    }

    .device-risk.moderate {
        background: #fef3c7;
        color: #92400e;
    }

    .device-risk.high {
        background: #fecaca;
        color: #991b1b;
    }

    /* Supply Items */
    .supply-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .supply-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
    }

    .supply-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: var(--mud-palette-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .supply-info {
        flex: 1;
    }

    .supply-name {
        font-weight: 600;
        font-size: 14px;
    }

    .supply-status {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .supply-level {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .supply-level.good {
        background: #dcfce7;
        color: #166534;
    }

    .supply-level.low {
        background: #fef3c7;
        color: #92400e;
    }

    .supply-level.critical {
        background: #fecaca;
        color: #991b1b;
    }

    /* Security Badge */
    .security-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 8px;
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-size: 11px;
        font-weight: 600;
    }

    .security-badge.secure {
        background: linear-gradient(135deg, #166534 0%, #22c55e 100%);
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .stat-cards {
            grid-template-columns: 1fr;
        }

        .layer-content {
            flex-direction: column;
            align-items: stretch;
        }

        .workflow-node {
            min-width: 100%;
        }

        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .header-right {
            width: 100%;
            justify-content: space-between;
        }
    }

    .vital-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s ease;
    }

    .vital-card:hover {
        background: #f1f5f9;
    }

    .vital-label {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 8px;
    }

    .vital-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--mud-palette-primary);
    }

    .vital-unit {
        font-size: 14px;
        color: var(--mud-palette-text-secondary);
    }

    .vital-range {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
        margin-top: 4px;
    }

    /* Subgroup containers for better visual organization */
    .subgroup-container {
        border: 2px dashed;
        border-radius: 12px;
        padding: 16px;
        margin: 8px 4px;
        position: relative;
        background: rgba(255, 255, 255, 0.5);
    }

    .subgroup-container.client-group {
        border-color: #a855f7;
        background: rgba(168, 85, 247, 0.05);
    }

    .subgroup-container.facility-group {
        border-color: #8b5cf6;
        background: rgba(139, 92, 246, 0.05);
    }

    .subgroup-container.cloud-services {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
    }

    .subgroup-container.regional-layer {
        border-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .subgroup-label {
        position: absolute;
        top: -10px;
        left: 16px;
        background: white;
        padding: 2px 10px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .subgroup-label.client-group {
        color: #a855f7;
    }

    .subgroup-label.facility-group {
        color: #8b5cf6;
    }

    .subgroup-label.cloud-services {
        color: #3b82f6;
    }

    .subgroup-label.regional-layer {
        color: #f59e0b;
    }

    .subgroup-nodes {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        align-items: flex-start;
    }

    .layer-subgroups {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }

    .flow-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        font-size: 16px;
        padding: 0 4px;
    }
</style>

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-icon">
                üè•
            </div>
            <div class="header-text-container">
                <h1 class="header-title">MedEdge System Dashboard</h1>
                <p class="header-subtitle">Global-Regional-Local Architecture | HIPAA/GDPR Compliant | Federated AI</p>
            </div>
        </div>
        <div class="header-right">
            <div class="security-badge secure">
                <span>üîí</span>
                <span>TPM Enabled</span>
            </div>
            <a href="https://github.com/bejranonda/MedEdge-Gateway" target="_blank" class="version-badge" style="text-decoration: none; cursor: pointer;">v2.0 Global Scale</a>
            <div class="realtime-badge">
                <span class="live-dot"></span>
                <span>LIVE</span>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stat-cards">
        <div class="stat-card" @onclick="@(() => ShowNodeDetails("medical-devices"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üì±</div>
            <div class="stat-content">
                <div class="stat-label">Total Devices</div>
                <div class="stat-value" style="font-size: 24px;">@totalDevices</div>
                <div class="stat-subtitle">@onlineDevices online</div>
            </div>
        </div>

        <div class="stat-card" @onclick="@(() => ShowNodeDetails("supply-center"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üì¶</div>
            <div class="stat-content">
                <div class="stat-label">Supply Center</div>
                <div class="stat-value" style="font-size: 24px;">@supplyItemsCount</div>
                <div class="stat-subtitle">@lowSupplyCount items low</div>
            </div>
        </div>

        <div class="stat-card" @onclick="@(() => ShowNodeDetails("services"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">‚ö°</div>
            <div class="stat-content">
                <div class="stat-label">Services</div>
                <div class="stat-value" style="font-size: 24px;">@healthyServices/@totalServices</div>
                <div class="stat-subtitle">containers running</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üìä</div>
            <div class="stat-content">
                <div class="stat-label">Throughput</div>
                <div class="stat-value" style="font-size: 24px;">@dataThroughput</div>
                <div class="stat-subtitle">points/min</div>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; align-items: start;">
        <!-- Main Workflow Diagram -->
        <div class="workflow-section" style="flex: 1;">
            <div class="workflow-header">
                <div class="workflow-title">
                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">System Workflow</MudText>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Click component for details
                </MudText>
            </div>

            <div class="workflow-canvas" style="min-height: 550px; padding: 20px;">
                <div class="layer-container">
                    <!-- GLOBAL Tier -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #22c55e;"></div>
                            <span class="layer-name">GLOBAL - Management & Analytics</span>
                            <span style="font-size: 10px; color: #22c55e; margin-left: 8px; font-weight: 600;">üåç Multi-Region</span>
                        </div>
                        <div class="layer-content">
                            <div class="workflow-node @(GetNodeStatus("global-management"))" @onclick="@(() => ShowNodeDetails("global-management"))">
                                <div class="node-icon @(GetNodeHealthClass("global-management"))" style="background: #22c55e;">
                                    <MudIcon Icon="@Icons.Material.Filled.Public" />
                                </div>
                                <div class="node-name">Global Device Mgmt</div>
                                <div class="node-status">
                                    <span class="status-dot healthy"></span>
                                    Fleet ‚Ä¢ OTA
                                </div>
                            </div>

                            <div class="workflow-node @(GetNodeStatus("global-analytics"))" @onclick="@(() => ShowNodeDetails("global-analytics"))">
                                <div class="node-icon @(GetNodeHealthClass("global-analytics"))" style="background: #22c55e;">
                                    <MudIcon Icon="@Icons.Material.Filled.Analytics" />
                                </div>
                                <div class="node-name">Global Analytics</div>
                                <div class="node-status">
                                    <span class="status-dot healthy"></span>
                                    ML Training
                                </div>
                            </div>

                            <div class="workflow-node @(GetNodeStatus("global-compliance"))" @onclick="@(() => ShowNodeDetails("global-compliance"))">
                                <div class="node-icon @(GetNodeHealthClass("global-compliance"))" style="background: #22c55e;">
                                    <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" />
                                </div>
                                <div class="node-name">Compliance</div>
                                <div class="node-status">
                                    <span class="status-dot healthy"></span>
                                    Audit
                                </div>
                            </div>

                            <div class="workflow-node @(GetNodeStatus("global-database"))" @onclick="@(() => ShowNodeDetails("global-database"))">
                                <div class="node-icon @(GetNodeHealthClass("global-database"))" style="background: #22c55e;">
                                    <MudIcon Icon="@Icons.Material.Filled.Storage" />
                                </div>
                                <div class="node-name">Global DB</div>
                                <div class="node-status">
                                    <span class="status-dot healthy"></span>
                                    No PHI
                                </div>
                            </div>
                        </div>
                        <div class="flow-arrow-down">
                            <div class="flow-arrow-line" style="background: linear-gradient(to bottom, #22c55e, #3b82f6);"></div>
                            <div class="flow-arrow-head" style="border-top-color: #3b82f6;"></div>
                        </div>
                    </div>

                    <!-- REGIONAL Tier -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #3b82f6;"></div>
                            <span class="layer-name">REGIONAL - Cloud & Services</span>
                            <span style="font-size: 10px; color: #3b82f6; margin-left: 8px; font-weight: 600;">üìç Data Residency</span>
                        </div>
                        <div class="layer-content" style="flex-direction: column;">
                            <!-- Cloud Services Group -->
                            <div class="subgroup-container cloud-services">
                                <div class="subgroup-label cloud-services">‚òÅÔ∏è Cloud Services</div>
                                <div class="subgroup-nodes">
                                    <div class="workflow-node active @(GetNodeStatus("treatment-service"))" @onclick="@(() => ShowNodeDetails("treatment-service"))">
                                        <div class="node-icon @(GetNodeHealthClass("treatment-service"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.EventNote" />
                                        </div>
                                        <div class="node-name">Treatment Service</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("treatment-service"))"></span>
                                            Sessions
                                        </div>
                                    </div>

                                    <div class="workflow-node active @(GetNodeStatus("coordination-service"))" @onclick="@(() => ShowNodeDetails("coordination-service"))">
                                        <div class="node-icon @(GetNodeHealthClass("coordination-service"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.DeviceHub" />
                                        </div>
                                        <div class="node-name">Device Coordination</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("coordination-service"))"></span>
                                            Stations
                                        </div>
                                    </div>

                                    <div class="workflow-node active @(GetNodeStatus("analytics-service"))" @onclick="@(() => ShowNodeDetails("analytics-service"))">
                                        <div class="node-icon @(GetNodeHealthClass("analytics-service"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.Analytics" />
                                        </div>
                                        <div class="node-name">Analytics</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("analytics-service"))"></span>
                                            Regional
                                        </div>
                                    </div>

                                    <div class="workflow-node active @(GetNodeStatus("transform-service"))" @onclick="@(() => ShowNodeDetails("transform-service"))">
                                        <div class="node-icon @(GetNodeHealthClass("transform-service"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.Transform" />
                                        </div>
                                        <div class="node-name">Transform</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("transform-service"))"></span>
                                            FHIR
                                        </div>
                                    </div>

                                    <div class="workflow-node active @(GetNodeStatus("fhir-api"))" @onclick="@(() => ShowNodeDetails("fhir-api"))">
                                        <div class="node-icon @(GetNodeHealthClass("fhir-api"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalHospital" />
                                        </div>
                                        <div class="node-name">FHIR API</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("fhir-api"))"></span>
                                            USCDI v3
                                        </div>
                                    </div>

                                    <div class="workflow-node @(GetNodeStatus("ai-engine"))" @onclick="@(() => ShowNodeDetails("ai-engine"))">
                                        <div class="node-icon @(GetNodeHealthClass("ai-engine"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.Psychology" />
                                        </div>
                                        <div class="node-name">AI Engine</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("ai-engine"))"></span>
                                            Federated
                                        </div>
                                    </div>

                                    <div class="workflow-node active @(GetNodeStatus("regional-database"))" @onclick="@(() => ShowNodeDetails("regional-database"))">
                                        <div class="node-icon @(GetNodeHealthClass("regional-database"))" style="background: #3b82f6;">
                                            <MudIcon Icon="@Icons.Material.Filled.Storage" />
                                        </div>
                                        <div class="node-name">Regional DB</div>
                                        <div class="node-status">
                                            <span class="status-dot healthy"></span>
                                            Cluster
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Regional Layer Group -->
                            <div class="subgroup-container regional-layer">
                                <div class="subgroup-label regional-layer">üè¢ Regional Layer</div>
                                <div class="subgroup-nodes">
                                    <div class="workflow-node @(GetNodeStatus("treatment-center-layer"))" @onclick="@(() => ShowNodeDetails("treatment-center-layer"))">
                                        <div class="node-icon @(GetNodeHealthClass("treatment-center-layer"))" style="background: #f59e0b;">
                                            <MudIcon Icon="@Icons.Material.Filled.LocalHospital" />
                                        </div>
                                        <div class="node-name">Treatment Center Interface</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("treatment-center-layer"))"></span>
                                            6 Zones ‚Ä¢ Connect to [Store] Gateway
                                        </div>
                                    </div>

                                    <div class="workflow-node @(GetNodeStatus("supply-center"))" @onclick="@(() => ShowNodeDetails("supply-center"))">
                                        <div class="node-icon @(GetNodeHealthClass("supply-center"))" style="background: #f59e0b;">
                                            <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                                        </div>
                                        <div class="node-name">Supply Center Interface</div>
                                        <div class="node-status">
                                            <span class="status-dot @(GetNodeHealthClass("supply-center"))"></span>
                                            Regional ‚Ä¢ Connect to [Hospital] Gateway
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flow-arrow-down">
                            <div class="flow-arrow-line" style="background: linear-gradient(to bottom, #3b82f6, #8b5cf6);"></div>
                            <div class="flow-arrow-head" style="border-top-color: #8b5cf6;"></div>
                        </div>
                    </div>

                    <!-- LOCAL Tier -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #8b5cf6;"></div>
                            <span class="layer-name">LOCAL - Facility Edge</span>
                            <span style="font-size: 10px; color: #8b5cf6; margin-left: 8px; font-weight: 600;">üè• HIPAA/GDPR</span>
                        </div>
                        <div class="layer-content" style="flex-direction: column;">
                            <div class="layer-subgroups">
                                <!-- Client Group -->
                                <div class="subgroup-container client-group" style="flex: 1; min-width: 300px;">
                                    <div class="subgroup-label client-group">üì± Client group (e.g. Treatment center)</div>
                                    <div class="subgroup-nodes">
                                        <div class="workflow-node @(GetNodeStatus("medical-devices"))" @onclick="@(() => ShowNodeDetails("medical-devices"))">
                                            <div class="node-icon @(GetNodeHealthClass("medical-devices"))" style="background: #a855f7;">
                                                <MudIcon Icon="@Icons.Material.Filled.MedicalServices" />
                                            </div>
                                            <div class="node-name">Medical Devices + Controller</div>
                                            <div class="node-status">
                                                <span class="status-dot @(GetNodeHealthClass("medical-devices"))"></span>
                                                @onlineDevices/@totalDevices ‚Ä¢ Modbus
                                            </div>
                                        </div>

                                        <div class="workflow-node @(GetNodeStatus("monitoring-center"))" @onclick="@(() => ShowNodeDetails("monitoring-center"))">
                                            <div class="node-icon @(GetNodeHealthClass("monitoring-center"))" style="background: #a855f7;">
                                                <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" />
                                            </div>
                                            <div class="node-name">Monitoring Ctr</div>
                                            <div class="node-status">
                                                <span class="status-dot @(GetNodeHealthClass("monitoring-center"))"></span>
                                                @activeMonitors
                                            </div>
                                        </div>

                                        <div class="workflow-node active @(GetNodeStatus("mqtt-broker"))" @onclick="@(() => ShowNodeDetails("mqtt-broker"))">
                                            <div class="node-icon @(GetNodeHealthClass("mqtt-broker"))" style="background: #a855f7;">
                                                <MudIcon Icon="@Icons.Material.Filled.Sensors" />
                                            </div>
                                            <div class="node-name">MQTT Broker</div>
                                            <div class="node-status">
                                                <span class="status-dot @(GetNodeHealthClass("mqtt-broker"))"></span>
                                                Connect to [Hospital] Gateway
                                            </div>
                                        </div>

                                        <div class="workflow-node active @(GetNodeStatus("edge-gateway-hospital"))" @onclick="@(() => ShowNodeDetails("edge-gateway-hospital"))">
                                            <div class="node-icon @(GetNodeHealthClass("edge-gateway-hospital"))" style="background: #a855f7;">
                                                <MudIcon Icon="@Icons.Material.Filled.Router" />
                                            </div>
                                            <div class="node-name">Edge Gateway</div>
                                            <div class="node-status">
                                                <span class="status-dot @(GetNodeHealthClass("edge-gateway-hospital"))"></span>
                                                [Hospital] ‚Üí Regional
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Facility Group -->
                                <div class="subgroup-container facility-group" style="flex: 1; min-width: 300px;">
                                    <div class="subgroup-label facility-group">üè• Facility Group</div>
                                    <div class="subgroup-nodes">


                                        <div class="workflow-node active @(GetNodeStatus("edge-gateway-store"))" @onclick="@(() => ShowNodeDetails("edge-gateway-store"))">
                                            <div class="node-icon @(GetNodeHealthClass("edge-gateway-store"))" style="background: #8b5cf6;">
                                                <MudIcon Icon="@Icons.Material.Filled.Router" />
                                            </div>
                                            <div class="node-name">Edge Gateway</div>
                                            <div class="node-status">
                                                <span class="status-dot @(GetNodeHealthClass("edge-gateway-store"))"></span>
                                                [Store] ‚Üí Regional
                                            </div>
                                        </div>

                                        <div class="workflow-node @(GetNodeStatus("local-database"))" @onclick="@(() => ShowNodeDetails("local-database"))">
                                            <div class="node-icon @(GetNodeHealthClass("local-database"))" style="background: #8b5cf6;">
                                                <MudIcon Icon="@Icons.Material.Filled.Storage" />
                                            </div>
                                            <div class="node-name">Local DB</div>
                                            <div class="node-status">
                                                <span class="status-dot healthy"></span>
                                                PHI Data
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div style="position: absolute; bottom: 16px; right: 16px; background: white; padding: 12px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 11px;">
                    <div style="font-weight: 700; margin-bottom: 6px;">Architecture Tiers</div>
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;"><div style="width: 12px; height: 12px; background: #22c55e; border-radius: 2px;"></div><span>Global: Management & Analytics (No PHI)</span></div>
                    <div style="display: flex; gap: 4px; margin-bottom: 4px;"><div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div><span>Regional: Cloud Services (Data Residency)</span></div>
                    <div style="display: flex; gap: 4px;"><div style="width: 12px; height: 12px; background: #8b5cf6; border-radius: 2px;"></div><span>Local: Facility Edge (HIPAA/GDPR)</span></div>
                </div>
            </div>
        </div>

        <!-- Detail Panel (Side Panel) -->
        <div style="width: 400px; display: @(selectedNodeDetails != null ? "block" : "none");">
            @if (selectedNodeDetails != null)
            {
                <div class="detail-panel" style="height: 100%; border-left: 4px solid var(--mud-palette-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">@selectedNodeDetails.Title</MudText>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@CloseNodeDetails" />
                    </div>

                    @if (selectedNodeDetails.NodeId == "services")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Container service status</MudText>
                        <div class="service-list">
                            @foreach (var service in services)
                            {
                                <div class="service-item">
                                    <div class="service-status @(service.Status.ToLower())"></div>
                                    <div class="service-info">
                                        <div class="service-name">@service.Name</div>
                                        <div class="service-description">@service.Description</div>
                                        <div class="service-url">@service.Url</div>
                                    </div>
                                </div>
                            }
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-primary);">
                            üîí All services run in isolated containers with TPM-backed authentication
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "supply-center")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">AI-Powered Supply Chain Interface</MudText>
                        <div class="detail-card mb-3" style="border-left-color: #3b82f6;">
                            <div class="detail-title">Status</div>
                            <div class="detail-value" style="font-size: 18px; color: #3b82f6;">AI Active</div>
                            <div class="detail-subtitle">Predictive consumption forecasting</div>
                        </div>
                        <div class="supply-list">
                            @foreach (var item in supplyItems)
                            {
                                <div class="supply-item">
                                    <div class="supply-icon">@item.Icon</div>
                                    <div class="supply-info">
                                        <div class="supply-name">@item.Name</div>
                                        <div class="supply-status">@item.Status</div>
                                    </div>
                                    <div class="supply-level @(item.LevelClass)">@item.Level</div>
                                </div>
                            }
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-text-secondary);">
                            ü§ñ AI predicts @predictedRestock restocks this week based on device usage patterns
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "medical-devices")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Connected medical devices + integrated controller</MudText>
                        <div class="device-list">
                            @foreach (var device in edgeDevices.Take(5))
                            {
                                <div class="device-item">
                                    <div class="device-status @(device.IsOnline ? "online" : "offline")"></div>
                                    <div class="device-info">
                                        <div class="device-name">@device.DeviceId</div>
                                        <div class="device-type">@device.Type</div>
                                    </div>
                                    <div class="device-risk @(device.RiskLevel?.ToLower() ?? "low")">@device.RiskLevel</div>
                                </div>
                            }
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "monitoring-center")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Central monitoring dashboard status</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Active Monitors</div>
                                <div class="detail-value" style="font-size: 18px;">@activeMonitors</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Connection</div>
                                <div class="detail-value" style="font-size: 18px;">API</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Gateway</div>
                                <div class="detail-value" style="font-size: 18px;">Connected</div>
                            </div>
                        </div>
                    }



                    @if (selectedNodeDetails.NodeId == "edge-gateway-hospital")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Edge gateway for hospital site</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Status</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayStatusText</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Throughput</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayMessages.ToString("F0") msg/s</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Protocol</div>
                                <div class="detail-value" style="font-size: 18px;">MQTT</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "edge-gateway-store")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Edge gateway for store site</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Status</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayStatusText</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Protocol</div>
                                <div class="detail-value" style="font-size: 18px;">API</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Active Connections</div>
                                <div class="detail-value" style="font-size: 18px;">@activeMonitors</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "edge-gateway")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Status</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayStatusText</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Throughput</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayMessages.ToString("F0") msg/s</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">MQTT</div>
                                <div class="detail-value" style="font-size: 18px;">@mqttStatusText</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "iot-hub")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Central IoT Hub with device management</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Connected Devices</div>
                                <div class="detail-value" style="font-size: 18px;">@totalDevices</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Security</div>
                                <div class="detail-value" style="font-size: 18px;">TPM 2.0</div>
                                <div class="detail-subtitle">Hardware-backed authentication</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Connections</div>
                                <div class="detail-value" style="font-size: 14px;">MQTT Broker, Edge Gateways</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "fhir-api")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">FHIR Version</div>
                                <div class="detail-value" style="font-size: 18px;">R4</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Observations</div>
                                <div class="detail-value" style="font-size: 18px;">@GetObservationsCount()</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Endpoint</div>
                                <div class="detail-value" style="font-size: 14px;">@(_config?.FhirBaseUrl ?? "N/A")</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "ai-engine")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #8b5cf6;">
                                <div class="detail-title">Predictive Maintenance</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                                <div class="detail-subtitle">AI forecasts device failures</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Consumption Forecast</div>
                                <div class="detail-value" style="font-size: 18px;">Enabled</div>
                                <div class="detail-subtitle">Supplies auto-replenishment</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Anomaly Detection</div>
                                <div class="detail-value" style="font-size: 18px;">Real-time</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "treatment-service")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Treatment session lifecycle management</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Active Sessions</div>
                                <div class="detail-value" style="font-size: 18px;">@activeSessions</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Stations Available</div>
                                <div class="detail-value" style="font-size: 18px;">@availableStations/@totalStations</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Zones Configured</div>
                                <div class="detail-value" style="font-size: 18px;">6 Zones</div>
                                <div class="detail-subtitle">52 Stations Total</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "coordination-service")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Multi-device coordination at treatment stations</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Stations Coordinated</div>
                                <div class="detail-value" style="font-size: 18px;">@coordinatedStations</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Emergency Stop</div>
                                <div class="detail-value" style="font-size: 18px;">Ready</div>
                                <div class="detail-subtitle">All stations support E-stop</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Device Groups</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                                <div class="detail-subtitle">Synchronized commands</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "analytics-service")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Treatment metrics and performance analytics</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #8b5cf6;">
                                <div class="detail-title">Daily Metrics</div>
                                <div class="detail-value" style="font-size: 18px;">@dailyTreatments</div>
                                <div class="detail-subtitle">Treatments today</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Trend Analysis</div>
                                <div class="detail-value" style="font-size: 18px;">7-day</div>
                                <div class="detail-subtitle">Performance trends</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Area Comparison</div>
                                <div class="detail-value" style="font-size: 18px;">Available</div>
                                <div class="detail-subtitle">Zone-by-zone metrics</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "transform-service")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">MQTT to FHIR transformation service</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Input Protocol</div>
                                <div class="detail-value" style="font-size: 18px;">MQTT</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Output Format</div>
                                <div class="detail-value" style="font-size: 18px;">FHIR R4</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">LOINC Mapping</div>
                                <div class="detail-value" style="font-size: 18px;">Enabled</div>
                                <div class="detail-subtitle">Standard codes</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Batch Processing</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                            </div>
                        </div>
                    }

                    // v2.0 Global Architecture Nodes
                    @if (selectedNodeDetails.NodeId == "global-management")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Global device fleet management and OTA updates</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Total Devices</div>
                                <div class="detail-value" style="font-size: 18px;">@(totalDevices * 12)</div>
                                <div class="detail-subtitle">Across all regions</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">OTA Updates</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                                <div class="detail-subtitle">Firmware & software distribution</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Regions</div>
                                <div class="detail-value" style="font-size: 18px;">3</div>
                                <div class="detail-subtitle">US, EU, APAC</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Data Sovereignty</div>
                                <div class="detail-value" style="font-size: 16px;">No PHI</div>
                                <div class="detail-subtitle">Device metadata only</div>
                            </div>
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-primary);">
                            üåç Global layer manages device fleet without accessing patient data
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "global-analytics")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Global analytics and federated learning coordination</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #8b5cf6;">
                                <div class="detail-title">ML Training</div>
                                <div class="detail-value" style="font-size: 18px;">Federated</div>
                                <div class="detail-subtitle">Model updates, not raw data</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Population Health</div>
                                <div class="detail-value" style="font-size: 18px;">Aggregated</div>
                                <div class="detail-subtitle">Anonymized insights only</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Model Versions</div>
                                <div class="detail-value" style="font-size: 18px;">24</div>
                                <div class="detail-subtitle">Active model artifacts</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "global-compliance")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Global compliance monitoring and audit logging</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Compliance Status</div>
                                <div class="detail-value" style="font-size: 18px;">100%</div>
                                <div class="detail-subtitle">HIPAA, GDPR, ISO 27001</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Audit Logs</div>
                                <div class="detail-value" style="font-size: 18px;">Immutable</div>
                                <div class="detail-subtitle">Blockchain-backed</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Last Audit</div>
                                <div class="detail-value" style="font-size: 18px;">Pass</div>
                                <div class="detail-subtitle">@DateTime.Now.AddDays(-7).ToString("MMM dd")</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "global-database")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Global distributed database (Cassandra)</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Database</div>
                                <div class="detail-value" style="font-size: 18px;">Cassandra</div>
                                <div class="detail-subtitle">Multi-region replication</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Replication</div>
                                <div class="detail-value" style="font-size: 18px;">3 regions</div>
                                <div class="detail-subtitle">Active-active</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Data Type</div>
                                <div class="detail-value" style="font-size: 16px;">No PHI</div>
                                <div class="detail-subtitle">Device catalog, analytics only</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "regional-database")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Regional PostgreSQL cluster with read replicas</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Database</div>
                                <div class="detail-value" style="font-size: 18px;">PostgreSQL</div>
                                <div class="detail-subtitle">Clustered with read replicas</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Data Residency</div>
                                <div class="detail-value" style="font-size: 18px;">Enforced</div>
                                <div class="detail-subtitle">GDPR compliant by region</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">HA Mode</div>
                                <div class="detail-value" style="font-size: 18px;">Active-Active</div>
                                <div class="detail-subtitle">Multi-AZ deployment</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "treatment-center-layer")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Regional treatment center interface layer</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #f59e0b;">
                                <div class="detail-title">Zones</div>
                                <div class="detail-value" style="font-size: 18px;">6</div>
                                <div class="detail-subtitle">A-D: Dialysis, E: ICU, F: General</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Total Stations</div>
                                <div class="detail-value" style="font-size: 18px;">52</div>
                                <div class="detail-subtitle">Per treatment center</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Service Coordination</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                                <div class="detail-subtitle">Multi-device synchronization</div>
                            </div>
                        </div>
                    }



                    @if (selectedNodeDetails.NodeId == "local-database")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Local facility database with PHI</MudText>
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #8b5cf6;">
                                <div class="detail-title">Database</div>
                                <div class="detail-value" style="font-size: 18px;">SQLite (Edge)</div>
                                <div class="detail-subtitle">PostgreSQL (Facility)</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Retention</div>
                                <div class="detail-value" style="font-size: 18px;">7 years</div>
                                <div class="detail-subtitle">Regulatory requirement</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Encryption</div>
                                <div class="detail-value" style="font-size: 18px;">AES-256</div>
                                <div class="detail-subtitle">At-rest and in-transit</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Backup</div>
                                <div class="detail-value" style="font-size: 18px;">Daily</div>
                                <div class="detail-subtitle">Local + regional</div>
                            </div>
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-primary);">
                            üîí Patient data stays within facility per HIPAA/GDPR
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "dashboard")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Session</div>
                                <div class="detail-value" style="font-size: 18px;">@sessionDuration.ToString("F0") min</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Updates</div>
                                <div class="detail-value" style="font-size: 18px;">@totalUpdates</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "vitals-preview" || selectedNodeDetails.NodeId == "medical-devices")
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Live Vitals Preview</MudText>
                        <div class="detail-card mb-3" style="border-left-color: #3b82f6;">
                            <div class="detail-title">Device</div>
                            <div class="detail-value" style="font-size: 16px;">@currentDeviceSerial</div>
                            <div class="detail-subtitle">@currentDeviceType</div>
                        </div>
                        <MudGrid Spacing="1">
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Blood Flow</div>
                                    <div class="vital-value" style="font-size: 18px;">@bloodFlow</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Art. Press</div>
                                    <div class="vital-value" style="font-size: 18px;">@arterialPressure</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Ven. Press</div>
                                    <div class="vital-value" style="font-size: 18px;">@venousPressure</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Temp</div>
                                    <div class="vital-value" style="font-size: 18px;">@temperature</div>
                                </div>
                            </MudItem>
                        </MudGrid>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="detail-panel" style="padding: 16px;">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@RefreshAll">
                    Refresh All
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Apps" OnClick="@(() => ShowNodeDetails("services"))">
                    View Services
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Inventory2" OnClick="@(() => ShowNodeDetails("supply-center"))">
                    Supply Center
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Tertiary" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.TrendingUp" OnClick="@(() => ShowNodeDetails("vitals-preview"))">
                    Live Vitals
                </MudButton>
            </MudItem>
        </MudGrid>
    </div>
</div>

@code {
    private AppConfiguration? _config;
    private int totalDevices = 0;
    private int onlineDevices = 0;
    private int offlineDevices = 0;
    private int errorDevices = 0;
    private int healthyServices = 0;
    private int totalServices = 0;
    private string dataThroughput = "0";
    private DateTime lastUpdateTime = DateTime.UtcNow;
    private DateTime sessionStart = DateTime.UtcNow;
    private string gatewayHealth = "healthy";
    private string gatewayStatusText = "Operational";
    private double gatewayMessages = 0;
    private string mqttStatus = "healthy";
    private string mqttStatusText = "Connected";
    private string signalrStatus = "healthy";
    private string signalrStatusText = "Connected";
    private int incomingMessages = 0;
    private int outgoingMessages = 0;
    private List<EdgeDevice> edgeDevices = new();
    private bool isLoadingDevices = false;
    private List<ServiceInfo> services = new();
    private System.Timers.Timer? refreshTimer;
    private NodeDetailInfo? selectedNodeDetails;
    private double sessionDuration => (DateTime.UtcNow - sessionStart).TotalMinutes;
    private int totalUpdates = 0;
    private int supplyItemsCount = 8;
    private int lowSupplyCount = 2;
    private int predictedRestock = 3;
    private List<SupplyItem> supplyItems = new();
    private int activeMonitors = 3;

    // Treatment Center data
    private int activeSessions = 8;
    private int availableStations = 44;
    private int totalStations = 52;
    private int coordinatedStations = 8;
    private int dailyTreatments = 24;

    // Vitals data with device serial
    private string currentDeviceSerial = "infusion-pump-001";
    private string currentDeviceType = "Infusion Pump";
    private double bloodFlow = 320;
    private double arterialPressure = 120;
    private double venousPressure = 80;
    private double temperature = 36.5;
    private double conductivity = 14.0;
    private int treatmentTime = 7200;

    public class EdgeDevice
    {
        public string DeviceId { get; set; } = string.Empty;
        public string SerialNumber { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public bool IsOnline { get; set; }
        public DateTime LastSeen { get; set; }
        public string? RiskLevel { get; set; }
    }

    public class ServiceInfo
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
        public string Status { get; set; } = "Unknown";
        public string ContainerName { get; set; } = string.Empty;
    }

    public class NodeDetailInfo
    {
        public string NodeId { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
    }

    public class SupplyItem
    {
        public string Name { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Level { get; set; } = string.Empty;
        public string LevelClass { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        _config = await ConfigService.LoadConfigurationAsync();
        InitializeServices();
        InitializeSupplyItems();
        await RefreshAll();
        refreshTimer = new System.Timers.Timer(3000);
        refreshTimer.Elapsed += async (sender, e) => await RefreshAll();
        refreshTimer.AutoReset = true;
        refreshTimer.Start();
    }

    private void InitializeServices()
    {
        services = new List<ServiceInfo>
        {
            new ServiceInfo {
                Name = "MQTT Broker",
                Description = "Eclipse Mosquitto - Message Queue",
                Url = "localhost:1883",
                Status = "Running",
                ContainerName = "medEdge-mqtt"
            },
            new ServiceInfo {
                Name = "Device Simulator",
                Description = "Modbus device simulation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-simulator"
            },
            new ServiceInfo {
                Name = "Edge Gateway",
                Description = "Modbus ‚Üí MQTT translation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-gateway"
            },
            new ServiceInfo {
                Name = "FHIR R4 API",
                Description = "Healthcare data exchange",
                Url = ":5001",
                Status = "Online",
                ContainerName = "medEdge-fhir-api"
            },
            new ServiceInfo {
                Name = "Transform Service",
                Description = "MQTT ‚Üí FHIR transformation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-transform"
            },
            new ServiceInfo {
                Name = "AI Clinical Engine",
                Description = "Predictive maintenance & forecasting",
                Url = "Container",
                Status = "Online",
                ContainerName = "medEdge-ai-engine"
            },
            new ServiceInfo {
                Name = "IoT Hub Simulator",
                Description = "Device registry, twins, DPS, TPM",
                Url = ":8080",
                Status = "Online",
                ContainerName = "mededge-iot-hub"
            },
            new ServiceInfo {
                Name = "Web Dashboard",
                Description = "System monitoring interface",
                Url = ":5000",
                Status = "Running",
                ContainerName = "medEdge-dashboard"
            },
            new ServiceInfo {
                Name = "Treatment Service",
                Description = "Treatment session lifecycle management",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-treatment-service"
            },
            new ServiceInfo {
                Name = "Device Coordination Service",
                Description = "Multi-device coordination at stations",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-coordination-service"
            },
            new ServiceInfo {
                Name = "Analytics Service",
                Description = "Treatment metrics & performance analytics",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-analytics-service"
            }
        };

        totalServices = services.Count;
        healthyServices = services.Count(s => s.Status == "Online" || s.Status == "Running" || s.Status == "Connected");
    }

    private void InitializeSupplyItems()
    {
        supplyItems = new List<SupplyItem>
        {
            new SupplyItem { Name = "Dialysis Filters", Icon = "üîß", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Blood Line Sets", Icon = "ü©∏", Status = "Adequate", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Saline Solution", Icon = "üíß", Status = "Running low", Level = "Low", LevelClass = "low" },
            new SupplyItem { Name = "Heparin Vials", Icon = "üíâ", Status = "Critical", Level = "Critical", LevelClass = "critical" },
            new SupplyItem { Name = "Disinfectant", Icon = "üß¥", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Gloves (Box)", Icon = "üß§", Status = "Running low", Level = "Low", LevelClass = "low" },
            new SupplyItem { Name = "Syringes", Icon = "üíâ", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Wound Dressings", Icon = "ü©π", Status = "In stock", Level = "Good", LevelClass = "good" }
        };

        supplyItemsCount = supplyItems.Count;
        lowSupplyCount = supplyItems.Count(s => s.LevelClass == "low" || s.LevelClass == "critical");
    }

    private async Task RefreshAll()
    {
        await Task.WhenAll(
            RefreshGatewayStats(),
            LoadEdgeDevices(),
            UpdateVitals(),
            CheckServiceHealth(),
            UpdateSupplyLevels()
        );

        totalUpdates++;
        lastUpdateTime = DateTime.UtcNow;
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshGatewayStats()
    {
        try
        {
            var random = new Random();
            gatewayMessages = random.Next(80, 120);
            incomingMessages = random.Next(40, 80);
            outgoingMessages = random.Next(35, 70);
            dataThroughput = (random.Next(800, 1500)).ToString();
            gatewayHealth = gatewayMessages > 50 ? "healthy" : "warning";
            gatewayStatusText = gatewayHealth == "healthy" ? "Operational" : "Degraded";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing gateway stats: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEdgeDevices()
    {
        isLoadingDevices = true;
        try
        {
            var url = _config?.DevicesApiUrl ?? "api/devices";
            try
            {
                var response = await Http.GetAsync(url);
                if (response.IsSuccessStatusCode)
                {
                    var devices = await response.Content.ReadFromJsonAsync<List<DeviceApiResponse>>();
                    if (devices != null)
                    {
                        edgeDevices = devices.Select(d => new EdgeDevice
                        {
                            DeviceId = d.DeviceId ?? "Unknown",
                            SerialNumber = d.SerialNumber ?? "N/A",
                            Type = d.Type ?? "Unknown",
                            IsOnline = d.IsOnline ?? false,
                            LastSeen = d.LastTelemetryTime ?? DateTime.UtcNow,
                            RiskLevel = d.RiskLevel ?? "Low"
                        }).ToList();
                    }
                }
            }
            catch
            {
                edgeDevices = GetMockDevices();
            }

            totalDevices = edgeDevices.Count;
            onlineDevices = edgeDevices.Count(d => d.IsOnline);
            offlineDevices = edgeDevices.Count(d => !d.IsOnline);

            // Set initial vitals device from online devices
            if (string.IsNullOrEmpty(currentDeviceSerial) || !edgeDevices.Any(d => d.DeviceId == currentDeviceSerial))
            {
                var firstOnlineDevice = edgeDevices.FirstOrDefault(d => d.IsOnline);
                if (firstOnlineDevice != null)
                {
                    currentDeviceSerial = firstOnlineDevice.DeviceId;
                    currentDeviceType = firstOnlineDevice.Type;
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading devices: {ex.Message}", Severity.Error);
            edgeDevices = GetMockDevices();
        }
        finally
        {
            isLoadingDevices = false;
        }
    }

    private List<EdgeDevice> GetMockDevices()
    {
        return new List<EdgeDevice>
        {
            new EdgeDevice { DeviceId = "dialysis-modern-001", SerialNumber = "DM-001", Type = "Dialysis Machine", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-5), RiskLevel = "Low" },
            new EdgeDevice { DeviceId = "dialysis-legacy-001", SerialNumber = "DL-001", Type = "Dialysis Machine", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-10), RiskLevel = "Low" },
            new EdgeDevice { DeviceId = "infusion-pump-001", SerialNumber = "IP-001", Type = "Infusion Pump", IsOnline = false, LastSeen = DateTime.UtcNow.AddMinutes(-5), RiskLevel = "Moderate" },
            new EdgeDevice { DeviceId = "ventilator-001", SerialNumber = "VT-001", Type = "Ventilator", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-3), RiskLevel = "Low" }
        };
    }

    private async Task UpdateVitals()
    {
        var random = new Random();

        // Get online devices to cycle through
        var onlineDevices = edgeDevices.Where(d => d.IsOnline).ToList();
        if (onlineDevices.Any())
        {
            // Occasionally switch to a different device's vitals
            if (random.Next(100) < 20) // 20% chance to switch device
            {
                var randomDevice = onlineDevices[random.Next(onlineDevices.Count)];
                currentDeviceSerial = randomDevice.DeviceId;
                currentDeviceType = randomDevice.Type;
                treatmentTime = 0; // Reset treatment time for new device
            }
        }

        bloodFlow = 300 + random.Next(-30, 50);
        arterialPressure = 110 + random.Next(-20, 30);
        venousPressure = 75 + random.Next(-15, 25);
        temperature = 36.3 + random.Next(-3, 7) * 0.1;
        conductivity = 13.8 + random.Next(-4, 6) * 0.1;
        treatmentTime += 3;
    }

    private async Task CheckServiceHealth()
    {
        var random = new Random();
        // Simulate service health variations
        foreach (var service in services)
        {
            if (random.Next(100) > 95)
            {
                service.Status = "Warning";
            }
            else
            {
                service.Status = service.Name.Contains("API") || service.Name.Contains("Engine") || service.Name.Contains("Hub") ? "Online" : "Running";
            }
        }
        healthyServices = services.Count(s => s.Status == "Online" || s.Status == "Running" || s.Status == "Connected");
        await Task.CompletedTask;
    }

    private async Task UpdateSupplyLevels()
    {
        var random = new Random();
        predictedRestock = random.Next(1, 5);
        await Task.CompletedTask;
    }

    private string GetNodeStatus(string nodeId)
    {
        if (nodeId == "medical-devices") return onlineDevices > 0 ? "status-healthy" : "status-warning";
        if (nodeId == "monitoring-center") return activeMonitors > 0 ? "status-healthy" : "status-warning";
        if (nodeId == "supply-center") return lowSupplyCount == 0 ? "status-healthy" : "status-warning";
        if (nodeId == "services") return healthyServices == totalServices ? "status-healthy" : "status-warning";
        if (nodeId == "controller") return gatewayHealth == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "edge-gateway-hospital") return gatewayHealth == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "edge-gateway-store") return gatewayHealth == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "edge-gateway") return gatewayHealth == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "mqtt-broker") return mqttStatus == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "iot-hub") return "status-healthy";
        if (nodeId == "fhir-api") return "status-healthy";
        if (nodeId == "ai-engine") return "status-healthy";
        if (nodeId == "dashboard") return "status-healthy";
        if (nodeId == "treatment-service") return "status-healthy";
        if (nodeId == "coordination-service") return "status-healthy";
        if (nodeId == "analytics-service") return "status-healthy";
        if (nodeId == "transform-service") return "status-healthy";
        // New v2.0 nodes
        if (nodeId == "global-management") return "status-healthy";
        if (nodeId == "global-analytics") return "status-healthy";
        if (nodeId == "global-compliance") return "status-healthy";
        if (nodeId == "global-database") return "status-healthy";
        if (nodeId == "regional-database") return "status-healthy";
        if (nodeId == "treatment-center-layer") return "status-healthy";
        if (nodeId == "treatment-center") return "status-healthy";
        if (nodeId == "local-database") return "status-healthy";
        return "";
    }

    private string GetNodeHealthClass(string nodeId)
    {
        if (nodeId == "medical-devices") return onlineDevices > 0 ? "healthy" : "warning";
        if (nodeId == "monitoring-center") return activeMonitors > 0 ? "healthy" : "warning";
        if (nodeId == "supply-center") return lowSupplyCount == 0 ? "healthy" : "warning";
        if (nodeId == "services") return healthyServices == totalServices ? "healthy" : "warning";
        if (nodeId == "controller") return gatewayHealth;
        if (nodeId == "edge-gateway-hospital") return gatewayHealth;
        if (nodeId == "edge-gateway-store") return gatewayHealth;
        if (nodeId == "edge-gateway") return gatewayHealth;
        if (nodeId == "mqtt-broker") return mqttStatus;
        if (nodeId == "iot-hub") return "healthy";
        if (nodeId == "fhir-api") return "healthy";
        if (nodeId == "ai-engine") return "healthy";
        if (nodeId == "dashboard") return "healthy";
        if (nodeId == "treatment-service") return "healthy";
        if (nodeId == "coordination-service") return "healthy";
        if (nodeId == "analytics-service") return "healthy";
        if (nodeId == "transform-service") return "healthy";
        // New v2.0 nodes - always healthy for demo
        if (nodeId == "global-management") return "healthy";
        if (nodeId == "global-analytics") return "healthy";
        if (nodeId == "global-compliance") return "healthy";
        if (nodeId == "global-database") return "healthy";
        if (nodeId == "regional-database") return "healthy";
        if (nodeId == "treatment-center-layer") return "healthy";
        if (nodeId == "treatment-center") return "healthy";
        if (nodeId == "local-database") return "healthy";
        return "healthy";
    }

    private void ShowNodeDetails(string nodeId)
    {
        var titleMap = new Dictionary<string, string>
        {
            { "medical-devices", "Medical Devices + Controller" },
            { "monitoring-center", "Monitoring Center" },
            { "supply-center", "Supply Center Interface" },
            { "services", "Container Services" },
            { "controller", "Controller" },
            { "edge-gateway", "Edge Gateway" },
            { "edge-gateway-hospital", "Edge Gateway [Hospital]" },
            { "edge-gateway-store", "Edge Gateway [Store]" },
            { "mqtt-broker", "MQTT Broker" },
            { "iot-hub", "IoT Hub Simulator" },
            { "fhir-api", "FHIR API" },
            { "ai-engine", "AI Clinical Engine" },
            { "dashboard", "Dashboard Info" },
            { "vitals-preview", "Live Vitals" },
            { "treatment-service", "Treatment Service" },
            { "coordination-service", "Device Coordination Service" },
            { "analytics-service", "Analytics Service" },
            { "transform-service", "Transform Service" },
            // v2.0 Global-Regional-Local Architecture
            { "global-management", "Global Device Management" },
            { "global-analytics", "Global Analytics & ML" },
            { "global-compliance", "Global Compliance & Audit" },
            { "global-database", "Global Database (Cassandra)" },
            { "regional-database", "Regional Database (PostgreSQL)" },
            { "treatment-center-layer", "Treatment Center Interface" },
            { "local-database", "Local Database" }
        };

        selectedNodeDetails = new NodeDetailInfo
        {
            NodeId = nodeId,
            Title = titleMap.TryGetValue(nodeId, out var title) ? title : nodeId.ToUpperInvariant()
        };
        StateHasChanged();
    }

    private void CloseNodeDetails()
    {
        selectedNodeDetails = null;
        StateHasChanged();
    }

    private string FormatTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalSeconds < 60) return $"{(int)diff.TotalSeconds}s ago";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        return dateTime.ToString("g");
    }

    private string FormatTreatmentTime(int seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return $"{ts.Hours}h {ts.Minutes}m";
    }

    private string GetObservationsCount()
    {
        var random = new Random();
        return (random.Next(1000, 5000)).ToString("N0");
    }

    public class DeviceApiResponse
    {
        public string? DeviceId { get; set; }
        public string? SerialNumber { get; set; }
        public string? Type { get; set; }
        public bool? IsOnline { get; set; }
        public DateTime? LastTelemetryTime { get; set; }
        public string? RiskLevel { get; set; }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (refreshTimer is not null)
        {
            refreshTimer.Stop();
            refreshTimer.Dispose();
        }
        await Task.CompletedTask;
    }
}
