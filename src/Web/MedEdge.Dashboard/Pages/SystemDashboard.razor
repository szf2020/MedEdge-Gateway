@page "/system-dashboard"
@page "/"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.SignalR.Client
@using MedEdge.Dashboard.Services
@inject HttpClient Http
@inject IAppConfigurationService ConfigService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>System Dashboard - MedEdge</PageTitle>

<style>
    .dashboard-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 12px 20px 20px 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
        min-height: 100vh;
    }

    .header-section {
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, #007a2e 100%);
        border-radius: 12px;
        padding: 16px 24px;
        color: white;
        box-shadow: 0 8px 24px rgba(0, 150, 57, 0.25);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 64px;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-icon {
        width: 40px;
        height: 40px;
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .header-text-container {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
    }

    .header-title {
        font-size: 18px;
        font-weight: 700;
        margin: 0;
        color: white;
    }

    .header-subtitle {
        font-size: 11px;
        color: rgba(255,255,255,0.8);
        margin: 0;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .version-badge {
        color: rgba(255,255,255,0.7);
        font-size: 11px;
        font-weight: 700;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 4px 8px;
        border-radius: 4px;
        background: rgba(0,0,0,0.15);
    }

    .realtime-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.2);
        font-size: 11px;
        font-weight: 600;
    }

    .live-dot {
        width: 6px;
        height: 6px;
        background: #22c55e;
        border-radius: 50%;
        animation: blink 1s infinite;
    }

    @@keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    .mud-main-content {
        padding-top: 8px !important;
    }

    .header-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .stat-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--mud-palette-primary), var(--mud-palette-primary-darken));
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        background: linear-gradient(135deg, var(--mud-palette-primary), var(--mud-palette-primary-darken));
        color: white;
    }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
        font-weight: 600;
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--mud-palette-primary);
        line-height: 1;
    }

    .stat-subtitle {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    /* Workflow Section */
    .workflow-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .workflow-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .workflow-title {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .workflow-canvas {
        position: relative;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: 16px;
        padding: 32px;
        min-height: 500px;
        overflow-x: auto;
    }

    .layer-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
    }

    .workflow-layer {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .layer-header {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .layer-indicator {
        width: 4px;
        height: 24px;
        border-radius: 2px;
    }

    .layer-name {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 700;
        color: var(--mud-palette-text-secondary);
    }

    .layer-content {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
        position: relative;
    }

    /* Flow arrows between layers */
    .flow-arrow-down {
        position: absolute;
        bottom: -28px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        pointer-events: none;
        z-index: 5;
    }

    .flow-arrow-line {
        width: 2px;
        height: 20px;
        background: linear-gradient(to bottom, var(--mud-palette-primary), #22c55e);
    }

    .flow-arrow-head {
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid #22c55e;
    }

    .workflow-node {
        position: relative;
        background: white;
        border: 2px solid var(--mud-palette-divider);
        border-radius: 12px;
        padding: 16px 20px;
        min-width: 160px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .workflow-node:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 24px rgba(0, 150, 57, 0.2);
        border-color: var(--mud-palette-primary);
    }

    .workflow-node.active {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        border-color: var(--mud-palette-primary);
    }

    .workflow-node.status-healthy {
        border-color: #22c55e;
    }

    .workflow-node.status-warning {
        border-color: #f59e0b;
    }

    .workflow-node.status-error {
        border-color: #ef4444;
    }

    .node-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--mud-palette-primary);
        color: white;
        font-size: 20px;
    }

    .node-icon.status-healthy {
        background: #22c55e;
    }

    .node-icon.status-warning {
        background: #f59e0b;
    }

    .node-icon.status-error {
        background: #ef4444;
    }

    .node-name {
        font-size: 13px;
        font-weight: 600;
        text-align: center;
    }

    .node-status {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-dot.healthy {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        animation: pulse-green 2s infinite;
    }

    .status-dot.warning {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        animation: pulse-orange 2s infinite;
    }

    .status-dot.error {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        animation: pulse-red 2s infinite;
    }

    @@keyframes pulse-green {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    @@keyframes pulse-orange {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    @@keyframes pulse-red {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    /* Detail Panels */
    .detail-panel {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }

    .detail-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        border-left: 4px solid var(--mud-palette-primary);
    }

    .detail-card.warning {
        border-left-color: #f59e0b;
    }

    .detail-card.error {
        border-left-color: #ef4444;
    }

    .detail-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--mud-palette-text-secondary);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .detail-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--mud-palette-text-primary);
    }

    .detail-subtitle {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        margin-top: 4px;
    }

    /* Service List */
    .service-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .service-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.2s ease;
    }

    .service-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .service-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .service-status.online {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .service-status.offline {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
    }

    .service-status.warning {
        background: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }

    .service-info {
        flex: 1;
    }

    .service-name {
        font-weight: 600;
        font-size: 14px;
    }

    .service-description {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .service-url {
        font-size: 11px;
        color: var(--mud-palette-primary);
        font-family: monospace;
    }

    /* Device List */
    .device-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .device-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .device-item:hover {
        background: #f1f5f9;
        transform: translateX(4px);
    }

    .device-status {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .device-status.online {
        background: #22c55e;
        box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    .device-status.offline {
        background: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
    }

    .device-info {
        flex: 1;
    }

    .device-name {
        font-weight: 600;
        font-size: 14px;
    }

    .device-type {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .device-risk {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .device-risk.low {
        background: #dcfce7;
        color: #166534;
    }

    .device-risk.moderate {
        background: #fef3c7;
        color: #92400e;
    }

    .device-risk.high {
        background: #fecaca;
        color: #991b1b;
    }

    /* Supply Items */
    .supply-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .supply-item {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px 16px;
    }

    .supply-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: var(--mud-palette-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .supply-info {
        flex: 1;
    }

    .supply-name {
        font-weight: 600;
        font-size: 14px;
    }

    .supply-status {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
    }

    .supply-level {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .supply-level.good {
        background: #dcfce7;
        color: #166534;
    }

    .supply-level.low {
        background: #fef3c7;
        color: #92400e;
    }

    .supply-level.critical {
        background: #fecaca;
        color: #991b1b;
    }

    /* Security Badge */
    .security-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 8px;
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        color: white;
        font-size: 11px;
        font-weight: 600;
    }

    .security-badge.secure {
        background: linear-gradient(135deg, #166534 0%, #22c55e 100%);
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .stat-cards {
            grid-template-columns: 1fr;
        }

        .layer-content {
            flex-direction: column;
            align-items: stretch;
        }

        .workflow-node {
            min-width: 100%;
        }

        .header-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .header-right {
            width: 100%;
            justify-content: space-between;
        }
    }

    .vital-card {
        background: #f8fafc;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s ease;
    }

    .vital-card:hover {
        background: #f1f5f9;
    }

    .vital-label {
        font-size: 12px;
        color: var(--mud-palette-text-secondary);
        margin-bottom: 8px;
    }

    .vital-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--mud-palette-primary);
    }

    .vital-unit {
        font-size: 14px;
        color: var(--mud-palette-text-secondary);
    }

    .vital-range {
        font-size: 11px;
        color: var(--mud-palette-text-secondary);
        margin-top: 4px;
    }
</style>

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-content">
            <div class="header-icon">
                üè•
            </div>
            <div class="header-text-container">
                <h1 class="header-title">MedEdge System Dashboard</h1>
                <p class="header-subtitle">Real-time Medical IoT Monitoring & Supply Chain Management</p>
            </div>
        </div>
        <div class="header-right">
            <div class="security-badge secure">
                <span>üîí</span>
                <span>TPM Enabled</span>
            </div>
            <div class="version-badge">RELEASE: v1.2.0-beta</div>
            <div class="realtime-badge">
                <span class="live-dot"></span>
                <span>LIVE</span>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stat-cards">
        <div class="stat-card" @onclick="@(() => ShowNodeDetails("medical-devices"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üì±</div>
            <div class="stat-content">
                <div class="stat-label">Total Devices</div>
                <div class="stat-value" style="font-size: 24px;">@totalDevices</div>
                <div class="stat-subtitle">@onlineDevices online</div>
            </div>
        </div>

        <div class="stat-card" @onclick="@(() => ShowNodeDetails("supply-center"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üì¶</div>
            <div class="stat-content">
                <div class="stat-label">Supply Center</div>
                <div class="stat-value" style="font-size: 24px;">@supplyItemsCount</div>
                <div class="stat-subtitle">@lowSupplyCount items low</div>
            </div>
        </div>

        <div class="stat-card" @onclick="@(() => ShowNodeDetails("services"))">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">‚ö°</div>
            <div class="stat-content">
                <div class="stat-label">Services</div>
                <div class="stat-value" style="font-size: 24px;">@healthyServices/@totalServices</div>
                <div class="stat-subtitle">containers running</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="width: 44px; height: 44px; font-size: 20px;">üìä</div>
            <div class="stat-content">
                <div class="stat-label">Throughput</div>
                <div class="stat-value" style="font-size: 24px;">@dataThroughput</div>
                <div class="stat-subtitle">points/min</div>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; align-items: start;">
        <!-- Main Workflow Diagram -->
        <div class="workflow-section" style="flex: 1;">
            <div class="workflow-header">
                <div class="workflow-title">
                    <MudIcon Icon="@Icons.Material.Filled.AccountTree" Color="Color.Primary" />
                    <MudText Typo="Typo.h6">System Workflow</MudText>
                </div>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Click component for details
                </MudText>
            </div>

            <div class="workflow-canvas" style="min-height: 450px; padding: 20px;">
                <div class="layer-container">
                    <!-- Facility Layer -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #6366f1;"></div>
                            <span class="layer-name">Facility Layer</span>
                        </div>
                        <div class="layer-content">
                            <div class="workflow-node @(GetNodeStatus("medical-devices"))" @onclick="@(() => ShowNodeDetails("medical-devices"))">
                                <div class="node-icon @(GetNodeHealthClass("medical-devices"))">
                                    <MudIcon Icon="@Icons.Material.Filled.MedicalServices" />
                                </div>
                                <div class="node-name">Medical Devices</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("medical-devices"))"></span>
                                    @totalDevices units
                                </div>
                            </div>

                            <div class="workflow-node @(GetNodeStatus("supply-center"))" @onclick="@(() => ShowNodeDetails("supply-center"))">
                                <div class="node-icon @(GetNodeHealthClass("supply-center"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Inventory2" />
                                </div>
                                <div class="node-name">Supply Center</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("supply-center"))"></span>
                                    AI Managed
                                </div>
                            </div>
                        </div>
                        <div class="flow-arrow-down">
                            <div class="flow-arrow-line"></div>
                            <div class="flow-arrow-head"></div>
                        </div>
                    </div>

                    <!-- Edge Layer -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #3b82f6;"></div>
                            <span class="layer-name">Edge Layer</span>
                        </div>
                        <div class="layer-content">
                            <div class="workflow-node active @(GetNodeStatus("edge-gateway"))" @onclick="@(() => ShowNodeDetails("edge-gateway"))">
                                <div class="node-icon @(GetNodeHealthClass("edge-gateway"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Router" />
                                </div>
                                <div class="node-name">Edge Gateway</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("edge-gateway"))"></span>
                                    @gatewayStatusText
                                </div>
                            </div>
                        </div>
                        <div class="flow-arrow-down">
                            <div class="flow-arrow-line"></div>
                            <div class="flow-arrow-head"></div>
                        </div>
                    </div>

                    <!-- Messaging Layer -->
                    <div class="workflow-layer" style="position: relative;">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #8b5cf6;"></div>
                            <span class="layer-name">Messaging Layer</span>
                        </div>
                        <div class="layer-content">
                            <div class="workflow-node active @(GetNodeStatus("mqtt-broker"))" @onclick="@(() => ShowNodeDetails("mqtt-broker"))">
                                <div class="node-icon @(GetNodeHealthClass("mqtt-broker"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Sensors" />
                                </div>
                                <div class="node-name">MQTT Broker</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("mqtt-broker"))"></span>
                                    @mqttStatusText
                                </div>
                            </div>
                        </div>
                        <div class="flow-arrow-down">
                            <div class="flow-arrow-line"></div>
                            <div class="flow-arrow-head"></div>
                        </div>
                    </div>

                    <!-- Cloud Layer -->
                    <div class="workflow-layer">
                        <div class="layer-header">
                            <div class="layer-indicator" style="background: #22c55e;"></div>
                            <span class="layer-name">Cloud & Services Layer</span>
                        </div>
                        <div class="layer-content">
                            <div class="workflow-node active @(GetNodeStatus("services"))" @onclick="@(() => ShowNodeDetails("services"))">
                                <div class="node-icon @(GetNodeHealthClass("services"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Apps" />
                                </div>
                                <div class="node-name">Services</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("services"))"></span>
                                    @healthyServices/@totalServices
                                </div>
                            </div>

                            <div class="workflow-node active @(GetNodeStatus("iot-hub"))" @onclick="@(() => ShowNodeDetails("iot-hub"))">
                                <div class="node-icon @(GetNodeHealthClass("iot-hub"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Cloud" />
                                </div>
                                <div class="node-name">IoT Hub</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("iot-hub"))"></span>
                                    TPM Ready
                                </div>
                            </div>

                            <div class="workflow-node active @(GetNodeStatus("fhir-api"))" @onclick="@(() => ShowNodeDetails("fhir-api"))">
                                <div class="node-icon @(GetNodeHealthClass("fhir-api"))">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" />
                                </div>
                                <div class="node-name">FHIR API</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("fhir-api"))"></span>
                                    @GetObservationsCount()
                                </div>
                            </div>

                            <div class="workflow-node @(GetNodeStatus("ai-engine"))" @onclick="@(() => ShowNodeDetails("ai-engine"))">
                                <div class="node-icon @(GetNodeHealthClass("ai-engine"))">
                                    <MudIcon Icon="@Icons.Material.Filled.Psychology" />
                                </div>
                                <div class="node-name">AI Engine</div>
                                <div class="node-status">
                                    <span class="status-dot @(GetNodeHealthClass("ai-engine"))"></span>
                                    Predictive
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail Panel (Side Panel) -->
        <div style="width: 400px; display: @(selectedNodeDetails != null ? "block" : "none");">
            @if (selectedNodeDetails != null)
            {
                <div class="detail-panel" style="height: 100%; border-left: 4px solid var(--mud-palette-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">@selectedNodeDetails.Title</MudText>
                        </div>
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Size="Size.Small" OnClick="@CloseNodeDetails" />
                    </div>

                    @if (selectedNodeDetails.NodeId == "services")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Container service status</MudText>
                        <div class="service-list">
                            @foreach (var service in services)
                            {
                                <div class="service-item">
                                    <div class="service-status @(service.Status.ToLower())"></div>
                                    <div class="service-info">
                                        <div class="service-name">@service.Name</div>
                                        <div class="service-description">@service.Description</div>
                                        <div class="service-url">@service.Url</div>
                                    </div>
                                </div>
                            }
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-primary);">
                            üîí All services run in isolated containers with TPM-backed authentication
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "supply-center")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">AI-Powered Supply Chain Management</MudText>
                        <div class="detail-card mb-3" style="border-left-color: #3b82f6;">
                            <div class="detail-title">Status</div>
                            <div class="detail-value" style="font-size: 18px; color: #3b82f6;">AI Active</div>
                            <div class="detail-subtitle">Predictive consumption forecasting</div>
                        </div>
                        <div class="supply-list">
                            @foreach (var item in supplyItems)
                            {
                                <div class="supply-item">
                                    <div class="supply-icon">@item.Icon</div>
                                    <div class="supply-info">
                                        <div class="supply-name">@item.Name</div>
                                        <div class="supply-status">@item.Status</div>
                                    </div>
                                    <div class="supply-level @(item.LevelClass)">@item.Level</div>
                                </div>
                            }
                        </div>
                        <MudText Typo="Typo.caption" Class="mt-4" Style="color: var(--mud-palette-text-secondary);">
                            ü§ñ AI predicts @predictedRestock restocks this week based on device usage patterns
                        </MudText>
                    }

                    @if (selectedNodeDetails.NodeId == "medical-devices")
                    {
                        <MudText Typo="Typo.body2" Class="mb-4">Connected medical devices</MudText>
                        <div class="device-list">
                            @foreach (var device in edgeDevices.Take(5))
                            {
                                <div class="device-item">
                                    <div class="device-status @(device.IsOnline ? "online" : "offline")"></div>
                                    <div class="device-info">
                                        <div class="device-name">@device.DeviceId</div>
                                        <div class="device-type">@device.Type</div>
                                    </div>
                                    <div class="device-risk @(device.RiskLevel?.ToLower() ?? "low")">@device.RiskLevel</div>
                                </div>
                            }
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "edge-gateway")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Status</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayStatusText</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Throughput</div>
                                <div class="detail-value" style="font-size: 18px;">@gatewayMessages.ToString("F0") msg/s</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">MQTT</div>
                                <div class="detail-value" style="font-size: 18px;">@mqttStatusText</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "iot-hub")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Device Provisioning</div>
                                <div class="detail-value" style="font-size: 18px;">Auto (DPS)</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #22c55e;">
                                <div class="detail-title">Security</div>
                                <div class="detail-value" style="font-size: 18px;">TPM 2.0</div>
                                <div class="detail-subtitle">Hardware-backed authentication</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Twin Sync</div>
                                <div class="detail-value" style="font-size: 18px;">Real-time</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "fhir-api")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">FHIR Version</div>
                                <div class="detail-value" style="font-size: 18px;">R4</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Observations</div>
                                <div class="detail-value" style="font-size: 18px;">@GetObservationsCount()</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Endpoint</div>
                                <div class="detail-value" style="font-size: 14px;">@(_config?.FhirBaseUrl ?? "N/A")</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "ai-engine")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2" style="border-left-color: #8b5cf6;">
                                <div class="detail-title">Predictive Maintenance</div>
                                <div class="detail-value" style="font-size: 18px;">Active</div>
                                <div class="detail-subtitle">AI forecasts device failures</div>
                            </div>
                            <div class="detail-card mb-2" style="border-left-color: #3b82f6;">
                                <div class="detail-title">Consumption Forecast</div>
                                <div class="detail-value" style="font-size: 18px;">Enabled</div>
                                <div class="detail-subtitle">Supplies auto-replenishment</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Anomaly Detection</div>
                                <div class="detail-value" style="font-size: 18px;">Real-time</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "dashboard")
                    {
                        <div class="device-list">
                            <div class="detail-card mb-2">
                                <div class="detail-title">Session</div>
                                <div class="detail-value" style="font-size: 18px;">@sessionDuration.ToString("F0") min</div>
                            </div>
                            <div class="detail-card mb-2">
                                <div class="detail-title">Updates</div>
                                <div class="detail-value" style="font-size: 18px;">@totalUpdates</div>
                            </div>
                        </div>
                    }

                    @if (selectedNodeDetails.NodeId == "vitals-preview" || selectedNodeDetails.NodeId == "medical-devices")
                    {
                        <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Live Vitals Preview</MudText>
                        <MudGrid Spacing="1">
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Blood Flow</div>
                                    <div class="vital-value" style="font-size: 18px;">@bloodFlow</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Art. Press</div>
                                    <div class="vital-value" style="font-size: 18px;">@arterialPressure</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Ven. Press</div>
                                    <div class="vital-value" style="font-size: 18px;">@venousPressure</div>
                                </div>
                            </MudItem>
                            <MudItem xs="6">
                                <div class="vital-card" style="padding: 8px;">
                                    <div class="vital-label" style="font-size: 10px;">Temp</div>
                                    <div class="vital-value" style="font-size: 18px;">@temperature</div>
                                </div>
                            </MudItem>
                        </MudGrid>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="detail-panel" style="padding: 16px;">
        <MudGrid Spacing="2">
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh" OnClick="@RefreshAll">
                    Refresh All
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Apps" OnClick="@(() => ShowNodeDetails("services"))">
                    View Services
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.Inventory2" OnClick="@(() => ShowNodeDetails("supply-center"))">
                    Supply Center
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudButton Variant="Variant.Filled" Color="Color.Tertiary" FullWidth="true" Size="Size.Small" StartIcon="@Icons.Material.Filled.TrendingUp" OnClick="@(() => ShowNodeDetails("vitals-preview"))">
                    Live Vitals
                </MudButton>
            </MudItem>
        </MudGrid>
    </div>
</div>

@code {
    private AppConfiguration? _config;
    private int totalDevices = 0;
    private int onlineDevices = 0;
    private int offlineDevices = 0;
    private int errorDevices = 0;
    private int healthyServices = 0;
    private int totalServices = 0;
    private string dataThroughput = "0";
    private DateTime lastUpdateTime = DateTime.UtcNow;
    private DateTime sessionStart = DateTime.UtcNow;
    private string gatewayHealth = "healthy";
    private string gatewayStatusText = "Operational";
    private double gatewayMessages = 0;
    private string mqttStatus = "healthy";
    private string mqttStatusText = "Connected";
    private string signalrStatus = "healthy";
    private string signalrStatusText = "Connected";
    private int incomingMessages = 0;
    private int outgoingMessages = 0;
    private List<EdgeDevice> edgeDevices = new();
    private bool isLoadingDevices = false;
    private List<ServiceInfo> services = new();
    private System.Timers.Timer? refreshTimer;
    private NodeDetailInfo? selectedNodeDetails;
    private double sessionDuration => (DateTime.UtcNow - sessionStart).TotalMinutes;
    private int totalUpdates = 0;
    private int supplyItemsCount = 8;
    private int lowSupplyCount = 2;
    private int predictedRestock = 3;
    private List<SupplyItem> supplyItems = new();

    // Vitals data
    private double bloodFlow = 320;
    private double arterialPressure = 120;
    private double venousPressure = 80;
    private double temperature = 36.5;
    private double conductivity = 14.0;
    private int treatmentTime = 7200;

    public class EdgeDevice
    {
        public string DeviceId { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
        public bool IsOnline { get; set; }
        public DateTime LastSeen { get; set; }
        public string? RiskLevel { get; set; }
    }

    public class ServiceInfo
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Url { get; set; } = string.Empty;
        public string Status { get; set; } = "Unknown";
        public string ContainerName { get; set; } = string.Empty;
    }

    public class NodeDetailInfo
    {
        public string NodeId { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
    }

    public class SupplyItem
    {
        public string Name { get; set; } = string.Empty;
        public string Icon { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string Level { get; set; } = string.Empty;
        public string LevelClass { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        _config = await ConfigService.LoadConfigurationAsync();
        InitializeServices();
        InitializeSupplyItems();
        await RefreshAll();
        refreshTimer = new System.Timers.Timer(3000);
        refreshTimer.Elapsed += async (sender, e) => await RefreshAll();
        refreshTimer.AutoReset = true;
        refreshTimer.Start();
    }

    private void InitializeServices()
    {
        services = new List<ServiceInfo>
        {
            new ServiceInfo {
                Name = "MQTT Broker",
                Description = "Eclipse Mosquitto - Message Queue",
                Url = "localhost:1883",
                Status = "Running",
                ContainerName = "medEdge-mqtt"
            },
            new ServiceInfo {
                Name = "Device Simulator",
                Description = "Modbus device simulation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-simulator"
            },
            new ServiceInfo {
                Name = "Edge Gateway",
                Description = "Modbus ‚Üí MQTT translation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-gateway"
            },
            new ServiceInfo {
                Name = "FHIR R4 API",
                Description = "Healthcare data exchange",
                Url = ":5001",
                Status = "Online",
                ContainerName = "medEdge-fhir-api"
            },
            new ServiceInfo {
                Name = "Transform Service",
                Description = "MQTT ‚Üí FHIR transformation",
                Url = "Container",
                Status = "Running",
                ContainerName = "medEdge-transform"
            },
            new ServiceInfo {
                Name = "AI Clinical Engine",
                Description = "Predictive maintenance & forecasting",
                Url = "Container",
                Status = "Online",
                ContainerName = "medEdge-ai-engine"
            },
            new ServiceInfo {
                Name = "IoT Hub Simulator",
                Description = "Device registry, twins, DPS, TPM",
                Url = ":8080",
                Status = "Online",
                ContainerName = "mededge-iot-hub"
            },
            new ServiceInfo {
                Name = "Web Dashboard",
                Description = "System monitoring interface",
                Url = ":5000",
                Status = "Running",
                ContainerName = "medEdge-dashboard"
            }
        };

        totalServices = services.Count;
        healthyServices = services.Count(s => s.Status == "Online" || s.Status == "Running" || s.Status == "Connected");
    }

    private void InitializeSupplyItems()
    {
        supplyItems = new List<SupplyItem>
        {
            new SupplyItem { Name = "Dialysis Filters", Icon = "üîß", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Blood Line Sets", Icon = "ü©∏", Status = "Adequate", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Saline Solution", Icon = "üíß", Status = "Running low", Level = "Low", LevelClass = "low" },
            new SupplyItem { Name = "Heparin Vials", Icon = "üíâ", Status = "Critical", Level = "Critical", LevelClass = "critical" },
            new SupplyItem { Name = "Disinfectant", Icon = "üß¥", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Gloves (Box)", Icon = "üß§", Status = "Running low", Level = "Low", LevelClass = "low" },
            new SupplyItem { Name = "Syringes", Icon = "üíâ", Status = "In stock", Level = "Good", LevelClass = "good" },
            new SupplyItem { Name = "Wound Dressings", Icon = "ü©π", Status = "In stock", Level = "Good", LevelClass = "good" }
        };

        supplyItemsCount = supplyItems.Count;
        lowSupplyCount = supplyItems.Count(s => s.LevelClass == "low" || s.LevelClass == "critical");
    }

    private async Task RefreshAll()
    {
        await Task.WhenAll(
            RefreshGatewayStats(),
            LoadEdgeDevices(),
            UpdateVitals(),
            CheckServiceHealth(),
            UpdateSupplyLevels()
        );

        totalUpdates++;
        lastUpdateTime = DateTime.UtcNow;
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshGatewayStats()
    {
        try
        {
            var random = new Random();
            gatewayMessages = random.Next(80, 120);
            incomingMessages = random.Next(40, 80);
            outgoingMessages = random.Next(35, 70);
            dataThroughput = (random.Next(800, 1500)).ToString();
            gatewayHealth = gatewayMessages > 50 ? "healthy" : "warning";
            gatewayStatusText = gatewayHealth == "healthy" ? "Operational" : "Degraded";
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing gateway stats: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadEdgeDevices()
    {
        isLoadingDevices = true;
        try
        {
            var url = _config?.DevicesApiUrl ?? "api/devices";
            try
            {
                var response = await Http.GetAsync(url);
                if (response.IsSuccessStatusCode)
                {
                    var devices = await response.Content.ReadFromJsonAsync<List<DeviceApiResponse>>();
                    if (devices != null)
                    {
                        edgeDevices = devices.Select(d => new EdgeDevice
                        {
                            DeviceId = d.DeviceId ?? "Unknown",
                            Type = d.Type ?? "Unknown",
                            IsOnline = d.IsOnline ?? false,
                            LastSeen = d.LastTelemetryTime ?? DateTime.UtcNow,
                            RiskLevel = d.RiskLevel ?? "Low"
                        }).ToList();
                    }
                }
            }
            catch
            {
                edgeDevices = GetMockDevices();
            }

            totalDevices = edgeDevices.Count;
            onlineDevices = edgeDevices.Count(d => d.IsOnline);
            offlineDevices = edgeDevices.Count(d => !d.IsOnline);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading devices: {ex.Message}", Severity.Error);
            edgeDevices = GetMockDevices();
        }
        finally
        {
            isLoadingDevices = false;
        }
    }

    private List<EdgeDevice> GetMockDevices()
    {
        return new List<EdgeDevice>
        {
            new EdgeDevice { DeviceId = "dialysis-modern-001", Type = "Dialysis Machine", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-5), RiskLevel = "Low" },
            new EdgeDevice { DeviceId = "dialysis-legacy-001", Type = "Dialysis Machine", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-10), RiskLevel = "Low" },
            new EdgeDevice { DeviceId = "infusion-pump-001", Type = "Infusion Pump", IsOnline = false, LastSeen = DateTime.UtcNow.AddMinutes(-5), RiskLevel = "Moderate" },
            new EdgeDevice { DeviceId = "ventilator-001", Type = "Ventilator", IsOnline = true, LastSeen = DateTime.UtcNow.AddSeconds(-3), RiskLevel = "Low" }
        };
    }

    private async Task UpdateVitals()
    {
        var random = new Random();
        bloodFlow = 300 + random.Next(-30, 50);
        arterialPressure = 110 + random.Next(-20, 30);
        venousPressure = 75 + random.Next(-15, 25);
        temperature = 36.3 + random.Next(-3, 7) * 0.1;
        conductivity = 13.8 + random.Next(-4, 6) * 0.1;
        treatmentTime += 3;
    }

    private async Task CheckServiceHealth()
    {
        var random = new Random();
        // Simulate service health variations
        foreach (var service in services)
        {
            if (random.Next(100) > 95)
            {
                service.Status = "Warning";
            }
            else
            {
                service.Status = service.Name.Contains("API") || service.Name.Contains("Engine") || service.Name.Contains("Hub") ? "Online" : "Running";
            }
        }
        healthyServices = services.Count(s => s.Status == "Online" || s.Status == "Running" || s.Status == "Connected");
        await Task.CompletedTask;
    }

    private async Task UpdateSupplyLevels()
    {
        var random = new Random();
        predictedRestock = random.Next(1, 5);
        await Task.CompletedTask;
    }

    private string GetNodeStatus(string nodeId)
    {
        if (nodeId == "medical-devices") return onlineDevices > 0 ? "status-healthy" : "status-warning";
        if (nodeId == "supply-center") return lowSupplyCount == 0 ? "status-healthy" : "status-warning";
        if (nodeId == "services") return healthyServices == totalServices ? "status-healthy" : "status-warning";
        if (nodeId == "edge-gateway") return gatewayHealth == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "mqtt-broker") return mqttStatus == "healthy" ? "status-healthy" : "status-warning";
        if (nodeId == "iot-hub") return "status-healthy";
        if (nodeId == "fhir-api") return "status-healthy";
        if (nodeId == "ai-engine") return "status-healthy";
        if (nodeId == "dashboard") return "status-healthy";
        return "";
    }

    private string GetNodeHealthClass(string nodeId)
    {
        if (nodeId == "medical-devices") return onlineDevices > 0 ? "healthy" : "warning";
        if (nodeId == "supply-center") return lowSupplyCount == 0 ? "healthy" : "warning";
        if (nodeId == "services") return healthyServices == totalServices ? "healthy" : "warning";
        if (nodeId == "edge-gateway") return gatewayHealth;
        if (nodeId == "mqtt-broker") return mqttStatus;
        if (nodeId == "iot-hub") return "healthy";
        if (nodeId == "fhir-api") return "healthy";
        if (nodeId == "ai-engine") return "healthy";
        if (nodeId == "dashboard") return "healthy";
        return "healthy";
    }

    private void ShowNodeDetails(string nodeId)
    {
        var titleMap = new Dictionary<string, string>
        {
            { "medical-devices", "Medical Devices" },
            { "supply-center", "Supply Center" },
            { "services", "Container Services" },
            { "edge-gateway", "Edge Gateway" },
            { "mqtt-broker", "MQTT Broker" },
            { "iot-hub", "IoT Hub Simulator" },
            { "fhir-api", "FHIR API" },
            { "ai-engine", "AI Engine" },
            { "dashboard", "Dashboard Info" },
            { "vitals-preview", "Live Vitals" }
        };

        selectedNodeDetails = new NodeDetailInfo
        {
            NodeId = nodeId,
            Title = titleMap.TryGetValue(nodeId, out var title) ? title : nodeId.ToUpperInvariant()
        };
        StateHasChanged();
    }

    private void CloseNodeDetails()
    {
        selectedNodeDetails = null;
        StateHasChanged();
    }

    private string FormatTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalSeconds < 60) return $"{(int)diff.TotalSeconds}s ago";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        return dateTime.ToString("g");
    }

    private string FormatTreatmentTime(int seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return $"{ts.Hours}h {ts.Minutes}m";
    }

    private string GetObservationsCount()
    {
        var random = new Random();
        return (random.Next(1000, 5000)).ToString("N0");
    }

    public class DeviceApiResponse
    {
        public string? DeviceId { get; set; }
        public string? Type { get; set; }
        public bool? IsOnline { get; set; }
        public DateTime? LastTelemetryTime { get; set; }
        public string? RiskLevel { get; set; }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (refreshTimer is not null)
        {
            refreshTimer.Stop();
            refreshTimer.Dispose();
        }
        await Task.CompletedTask;
    }
}
