@page "/vitals-monitor"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.SignalR.Client
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IAsyncDisposable

<PageTitle>Live Vitals - MedEdge</PageTitle>

<MudContainer MaxWidth="MaxWidth.Lg">
    <MudText Typo="Typo.h4" Class="mb-4">Live Vitals Monitor</MudText>

    <MudGrid>
        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Spacing="2">
                    <MudSelect @bind-Value="selectedDeviceId" Label="Select Device" Variant="Variant.Outlined">
                        @foreach (var device in availableDevices)
                        {
                            <MudSelectItem Value="@device">@device</MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@ConnectToDevice">
                        Connect
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="@DisconnectFromDevice">
                        Disconnect
                    </MudButton>
                </MudStack>
            </MudPaper>
        </MudItem>

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <MudItem xs="12">
                <MudAlert Severity="@statusSeverity">@statusMessage</MudAlert>
            </MudItem>
        }

        @if (isConnected && alerts.Any())
        {
            <MudItem xs="12">
                <MudPaper Elevation="2" Class="pa-4" Style="background-color: #FFEBEE; border-left: 4px solid #D32F2F;">
                    <MudText Typo="Typo.h6" Color="Color.Error">‚ö†Ô∏è Clinical Alerts</MudText>
                    <MudStack Spacing="1" Class="mt-2">
                        @foreach (var alert in alerts)
                        {
                            <MudText Typo="Typo.body2">
                                <strong>@alert.Severity:</strong> @alert.Finding
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @alert.Recommendation
                            </MudText>
                        }
                    </MudStack>
                </MudPaper>
            </MudItem>
        }

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Blood Flow Rate (mL/min)</MudText>
                <MudText Typo="Typo.h4" Color="GetValueColor(bloodFlow, 150, 400)">
                    @bloodFlow.ToString("F1")
                </MudText>
                <MudLinearProgress Value="@GetNormalizedValue(bloodFlow, 100, 500)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Normal: 200-400 mL/min</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Arterial Pressure (mmHg)</MudText>
                <MudText Typo="Typo.h4" Color="GetValueColor(arterialPressure, 80, 200)">
                    @arterialPressure.ToString("F1")
                </MudText>
                <MudLinearProgress Value="@GetNormalizedValue(arterialPressure, 50, 250)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Normal: 50-200 mmHg</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Venous Pressure (mmHg)</MudText>
                <MudText Typo="Typo.h4" Color="GetValueColor(venousPressure, 0, 250)">
                    @venousPressure.ToString("F1")
                </MudText>
                <MudLinearProgress Value="@GetNormalizedValue(venousPressure, 0, 300)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Normal: 50-200 mmHg</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Temperature (¬∞C)</MudText>
                <MudText Typo="Typo.h4" Color="GetValueColor(temperature, 35, 38.5)">
                    @temperature.ToString("F1")
                </MudText>
                <MudLinearProgress Value="@GetNormalizedValue(temperature, 34, 39)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Normal: 35-38¬∞C</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Conductivity (mS/cm)</MudText>
                <MudText Typo="Typo.h4" Color="GetValueColor(conductivity, 13.0, 15.0)">
                    @conductivity.ToString("F2")
                </MudText>
                <MudLinearProgress Value="@GetNormalizedValue(conductivity, 12, 16)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Normal: 13.5-14.5 mS/cm</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-2">Treatment Time</MudText>
                <MudText Typo="Typo.h4">
                    @FormatDuration(treatmentTime)
                </MudText>
                <MudLinearProgress Value="@GetTreatmentProgress(treatmentTime)" Color="Color.Primary" Class="mt-2" />
                <MudText Typo="Typo.caption" Class="mt-2">Session Duration: 4 hours</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.subtitle1">Connection Status</MudText>
                <MudText Typo="Typo.body2" Color="@(isConnected ? Color.Success : Color.Error)">
                    @(isConnected ? "üü¢ Connected via SignalR" : "üî¥ Disconnected")
                </MudText>
                <MudText Typo="Typo.caption" Class="mt-2">
                    Last Update: @(lastUpdateTime == DateTime.MinValue ? "Never" : FormatTime(lastUpdateTime))
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private HubConnection? hubConnection;
    private string selectedDeviceId = "Device-001";
    private List<string> availableDevices = new() { "Device-001", "Device-002", "Device-003" };
    private bool isConnected = false;
    private DateTime lastUpdateTime = DateTime.MinValue;

    private double bloodFlow = 320;
    private double arterialPressure = 120;
    private double venousPressure = 80;
    private double temperature = 36.5;
    private double conductivity = 14.0;
    private int treatmentTime = 0;

    private string statusMessage = string.Empty;
    private Severity statusSeverity = Severity.Info;
    private List<ClinicalAlert> alerts = new();

    private class ClinicalAlert
    {
        public string Severity { get; set; } = string.Empty;
        public string Finding { get; set; } = string.Empty;
        public string Recommendation { get; set; } = string.Empty;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("http://localhost:5001/hubs/telemetry"))
                .WithAutomaticReconnect()
                .Build();

            hubConnection.On<VitalSignUpdate>("VitalSignUpdate", async update =>
            {
                bloodFlow = update.BloodFlow;
                arterialPressure = update.ArterialPressure;
                venousPressure = update.VenousPressure;
                temperature = update.Temperature;
                conductivity = update.Conductivity;
                treatmentTime = update.TreatmentTime;
                lastUpdateTime = DateTime.UtcNow;
                StateHasChanged();
            });

            hubConnection.On<List<ClinicalAlert>>("AlertsReceived", async alertsList =>
            {
                alerts = alertsList;
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            statusMessage = $"Connection error: {ex.Message}";
            statusSeverity = Severity.Error;
        }
    }

    private async Task ConnectToDevice()
    {
        try
        {
            if (hubConnection?.State != HubConnectionState.Connected)
            {
                await hubConnection?.StartAsync()!;
            }

            await hubConnection?.InvokeAsync("SubscribeToDevice", selectedDeviceId)!;
            isConnected = true;
            statusMessage = $"Connected to {selectedDeviceId}";
            statusSeverity = Severity.Success;
        }
        catch (Exception ex)
        {
            statusMessage = $"Connection failed: {ex.Message}";
            statusSeverity = Severity.Error;
        }
    }

    private async Task DisconnectFromDevice()
    {
        try
        {
            if (hubConnection?.State == HubConnectionState.Connected)
            {
                await hubConnection.InvokeAsync("UnsubscribeFromDevice", selectedDeviceId);
            }
            isConnected = false;
            statusMessage = "Disconnected";
            statusSeverity = Severity.Info;
            alerts.Clear();
        }
        catch (Exception ex)
        {
            statusMessage = $"Disconnection error: {ex.Message}";
            statusSeverity = Severity.Error;
        }
    }

    private Color GetValueColor(double value, double minNormal, double maxNormal)
    {
        if (value < minNormal * 0.8)
            return Color.Error;
        if (value > maxNormal * 1.2)
            return Color.Error;
        if (value < minNormal)
            return Color.Warning;
        if (value > maxNormal)
            return Color.Warning;
        return Color.Success;
    }

    private double GetNormalizedValue(double value, double min, double max)
    {
        return Math.Max(0, Math.Min(100, (value - min) / (max - min) * 100));
    }

    private double GetTreatmentProgress(int seconds)
    {
        const int sessionDuration = 14400; // 4 hours
        return (double)seconds / sessionDuration * 100;
    }

    private string FormatDuration(int seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        return $"{ts.Hours}h {ts.Minutes}m {ts.Seconds}s";
    }

    private string FormatTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalSeconds < 60)
            return $"{(int)diff.TotalSeconds}s ago";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        return dateTime.ToString("g");
    }

    private class VitalSignUpdate
    {
        public double BloodFlow { get; set; }
        public double ArterialPressure { get; set; }
        public double VenousPressure { get; set; }
        public double Temperature { get; set; }
        public double Conductivity { get; set; }
        public int TreatmentTime { get; set; }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
